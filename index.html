<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Liga de Ajedrez</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
    <link href="styles_ranking.css" rel="stylesheet">

</head>

<body>

    <div class="search-container">
        <input type="text" id="searchInput" placeholder="Buscar ajedrecista...">
    </div>

    <div class="table-container">
        <div id="loading">Actualizando ranking...</div>
        <table id="chessTable" style="display: none;">
            <thead>
                <tr>
                    <th>Ajedrecista</th>
                    <th>Nombre</th>
                    <th>Rtg</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
    <div id="noResults">No se encontró al jugador.</div>

    <script>
        const SHEET_ID = '11Sb1mrnFtsthIt2opjYkwh3Z9kSli5nzvA-p5cJiIvk';
        const SHEET_TITLE = 'Rating';
        const FULL_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${SHEET_TITLE}`;

        let playersData = [];

        async function loadData() {
            try {
                const response = await fetch(FULL_URL);
                const text = await response.text();
                const rows = text.split('\n').slice(1);

                playersData = rows.map(row => {
                    const col = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(c => c.replace(/"/g, '').trim());
                    return {
                        pos: col[0],
                        name: col[1],
                        rating: col[2],
                        photo: col[4] || "https://avatar.iran.liara.run/public"
                    };
                }).filter(p => p.name);

                renderTable(playersData);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('chessTable').style.display = 'table';
            } catch (e) {
                document.getElementById('loading').innerText = 'Error de conexión.';
            }
        }

        function renderTable(data) {
            const tbody = document.querySelector("#chessTable tbody");
            const mexicoFlag = "https://flagcdn.com/w40/mx.png";

            tbody.innerHTML = data.map(player => {
                // Envolvemos el número en un <span> para poder rotarlo independientemente del diamante
                return `
                    <tr data-pos="${player.pos}">
                        <td>
                            <div class="player-wrapper">
                                <div class="pos-badge"><span>${player.pos}</span></div>
                                <img src="${player.photo}" class="player-photo">
                                <img src="${mexicoFlag}" class="flag-badge">
                            </div>
                        </td>
                        <td><strong>${player.name}</strong></td>
                        <td class="rating-cell">${player.rating}</td>
                    </tr>
                `;
            }).join('');
        }

        document.getElementById('searchInput').addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            const filtered = playersData.filter(p => p.name.toLowerCase().includes(term));
            renderTable(filtered);
            document.getElementById('noResults').style.display = filtered.length ? 'none' : 'block';
        });

        loadData();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI"
        crossorigin="anonymous"></script>
</body>

</html>